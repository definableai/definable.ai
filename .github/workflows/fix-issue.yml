name: Auto Fix Issue

on:
  issues:
    types: [opened, labeled]

  # Manual trigger for re-running on specific issues
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to fix"
        required: true
        type: number

# Only one fix job per issue at a time
concurrency:
  group: fix-issue-${{ github.event.issue.number || github.event.inputs.issue_number }}
  cancel-in-progress: true

jobs:
  should-fix:
    name: Check if issue should be auto-fixed
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      issue_number: ${{ steps.check.outputs.issue_number }}
    steps:
      - name: Determine issue number and eligibility
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          ISSUE_LABELS: ${{ toJSON(github.event.issue.labels.*.name) }}
          ISSUE_STATE: ${{ github.event.issue.state }}
          ACTION: ${{ github.event.action }}
        run: |
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"

          # Manual dispatch always runs
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Manual trigger for issue #$ISSUE_NUMBER"
            exit 0
          fi

          # Skip closed issues
          if [ "$ISSUE_STATE" = "closed" ]; then
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            echo "â­ï¸ Issue is closed"
            exit 0
          fi

          # Skip labels that shouldn't be auto-fixed
          SKIP_LABELS='["wontfix","duplicate","question","needs-human","discussion","enhancement"]'
          for label in $(echo "$ISSUE_LABELS" | jq -r '.[]'); do
            if echo "$SKIP_LABELS" | jq -e "index(\"$label\")" > /dev/null 2>&1; then
              echo "should_run=false" >> "$GITHUB_OUTPUT"
              echo "â­ï¸ Skipping due to label: $label"
              exit 0
            fi
          done

          # On 'labeled' events, only proceed if the label is 'claude-fix'
          if [ "$ACTION" = "labeled" ]; then
            ADDED_LABEL="${{ github.event.label.name }}"
            if [ "$ADDED_LABEL" != "claude-fix" ]; then
              echo "should_run=false" >> "$GITHUB_OUTPUT"
              echo "â­ï¸ Label '$ADDED_LABEL' is not 'claude-fix'"
              exit 0
            fi
          fi

          # On 'opened' events, check if auto-fix-on-open is enabled
          if [ "$ACTION" = "opened" ]; then
            AUTOFIX_ON_OPEN="${{ vars.AUTOFIX_ON_OPEN || 'false' }}"
            if [ "$AUTOFIX_ON_OPEN" != "true" ]; then
              echo "should_run=false" >> "$GITHUB_OUTPUT"
              echo "â­ï¸ Auto-fix on open is disabled. Add label 'claude-fix' to trigger."
              exit 0
            fi
          fi

          echo "should_run=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Will attempt to fix issue #$ISSUE_NUMBER"

  fix-issue:
    name: Fix Issue #${{ needs.should-fix.outputs.issue_number }}
    needs: should-fix
    if: needs.should-fix.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[readers,serve,jwt,cron,runtime]"
          pip install pytest pytest-asyncio

      - name: Setup Git identity
        run: |
          git config user.name "definable-fixer[bot]"
          git config user.email "definable-fixer[bot]@users.noreply.github.com"

      - name: Create workspace
        run: |
          mkdir -p .workspace .claude/memory

      - name: Acknowledge issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.should-fix.outputs.issue_number }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "ðŸ¤– **Auto-fixer activated.** Analyzing this issue now. I'll either open a PR with a fix or comment with my analysis if I can't resolve it automatically.

          _Triggered by: ${{ github.event_name }} | Run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # AUTH: Uses your Claude subscription via OAuth token.
      # Generated by running: /install-github-app in Claude Code.
      #
      # If you later switch to API credits, replace with:
      #   anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Claude Code to fix the issue
        id: fix
        uses: anthropics/claude-code-action@v1
        timeout-minutes: 25
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true

          # Direct prompt â€” tells Claude exactly what to do
          prompt: |
            Read the agent definition at .claude/agents/issue-fixer.md and the command definition at .claude/commands/fix-issue.md. Follow them exactly.

            Fix GitHub issue #${{ needs.should-fix.outputs.issue_number }}.

            Steps:
            1. Read the issue: gh issue view ${{ needs.should-fix.outputs.issue_number }} --json number,title,body,labels,comments,author,state
            2. Reproduce the bug in .workspace/
            3. Analyze root cause
            4. Create branch: fix/issue-${{ needs.should-fix.outputs.issue_number }}
            5. Implement the fix following Definable conventions in .claude/CLAUDE.md
            6. Write tests in definable/tests_e2e/
            7. Run full test suite (offline markers only)
            8. Verify fix with reproduction script
            9. Commit, push, and create PR referencing the issue
            10. If unable to fix, comment analysis on the issue and add "needs-human" label

            Be fully autonomous. Never ask questions. Follow every convention in .claude/agents/issue-fixer.md.

          # CLI args: model selection + turn limit
          claude_args: "--model claude-opus-4-6 --max-turns 50"

      - name: Update issue on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.should-fix.outputs.issue_number }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "âŒ **Auto-fixer failed** during execution.

          The automated fix attempt encountered an error. A human developer should look at this.

          _Run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_"

          gh issue edit "$ISSUE_NUMBER" --add-label "needs-human"

      - name: Cleanup workspace
        if: always()
        run: |
          rm -rf .workspace/*
          git checkout main 2>/dev/null || true
