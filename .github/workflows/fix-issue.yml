name: Auto Fix Issue

on:
  issues:
    types: [opened, labeled]

  # Manual trigger for re-running on specific issues
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to fix"
        required: true
        type: number

# Only one fix job per issue at a time
concurrency:
  group: fix-issue-${{ github.event.issue.number || github.event.inputs.issue_number }}
  cancel-in-progress: true

jobs:
  should-fix:
    name: Check if issue should be auto-fixed
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      issue_number: ${{ steps.check.outputs.issue_number }}
    steps:
      - name: Determine issue number and eligibility
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          ISSUE_LABELS: ${{ toJSON(github.event.issue.labels.*.name) }}
          ISSUE_STATE: ${{ github.event.issue.state }}
          ACTION: ${{ github.event.action }}
        run: |
          echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"

          # Manual dispatch always runs
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Manual trigger for issue #$ISSUE_NUMBER"
            exit 0
          fi

          # Skip closed issues
          if [ "$ISSUE_STATE" = "closed" ]; then
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            echo "â­ï¸ Issue is closed"
            exit 0
          fi

          # Skip labels that shouldn't be auto-fixed
          SKIP_LABELS='["wontfix","duplicate","question","needs-human","discussion","enhancement"]'
          for label in $(echo "$ISSUE_LABELS" | jq -r '.[]'); do
            if echo "$SKIP_LABELS" | jq -e "index(\"$label\")" > /dev/null 2>&1; then
              echo "should_run=false" >> "$GITHUB_OUTPUT"
              echo "â­ï¸ Skipping due to label: $label"
              exit 0
            fi
          done

          # On 'labeled' events, only proceed if the label is 'claude-fix'
          if [ "$ACTION" = "labeled" ]; then
            ADDED_LABEL="${{ github.event.label.name }}"
            if [ "$ADDED_LABEL" != "claude-fix" ]; then
              echo "should_run=false" >> "$GITHUB_OUTPUT"
              echo "â­ï¸ Label '$ADDED_LABEL' is not 'claude-fix'"
              exit 0
            fi
          fi

          # On 'opened' events, check if auto-fix-on-open is enabled
          if [ "$ACTION" = "opened" ]; then
            AUTOFIX_ON_OPEN="${{ vars.AUTOFIX_ON_OPEN || 'false' }}"
            if [ "$AUTOFIX_ON_OPEN" != "true" ]; then
              echo "should_run=false" >> "$GITHUB_OUTPUT"
              echo "â­ï¸ Auto-fix on open is disabled. Add label 'claude-fix' to trigger."
              exit 0
            fi
          fi

          echo "should_run=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Will attempt to fix issue #$ISSUE_NUMBER"

  fix-issue:
    name: Fix Issue #${{ needs.should-fix.outputs.issue_number }}
    needs: should-fix
    if: needs.should-fix.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[readers,serve,jwt,cron,runtime,discord]"
          pip install pytest pytest-asyncio ruff mypy

      - name: Setup Git identity
        run: |
          git config user.name "definable-fixer[bot]"
          git config user.email "definable-fixer[bot]@users.noreply.github.com"

      - name: Create workspace
        run: |
          mkdir -p .workspace .claude/memory

      - name: Acknowledge issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.should-fix.outputs.issue_number }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "ðŸ¤– **Auto-fixer activated.** Analyzing this issue now. I'll either open a PR with a fix or comment with my analysis if I can't resolve it automatically.

          _Triggered by: ${{ github.event_name }} | Run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_"

      - name: Run Claude Code to fix the issue
        id: fix
        uses: anthropics/claude-code-action@v1
        timeout-minutes: 25
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true

          prompt: |
            You are an autonomous issue fixer for the Definable AI framework. Fix issue #${{ needs.should-fix.outputs.issue_number }}.

            RULES:
            - Be concise. Minimise token usage. Don't over-explain your reasoning.
            - Read .claude/agents/issue-fixer.md for conventions. Read .claude/CLAUDE.md for the API surface.
            - Do NOT ask for permission or confirmation. You are fully autonomous.

            STEPS:
            1. gh issue view ${{ needs.should-fix.outputs.issue_number }} --json number,title,body,labels,comments,state
            2. Read the relevant source files. Identify root cause.
            3. Write a minimal reproduction script in .workspace/ and run it to confirm the bug.
            4. git checkout -b fix/issue-${{ needs.should-fix.outputs.issue_number }}
            5. Implement the minimal fix. Follow existing code patterns.
            6. Write a test in definable/tests_e2e/ that fails on main and passes with your fix.

            7. MANDATORY BEFORE COMMITTING â€” run the CI lint checks and fix any issues:
               ruff check definable/ --fix
               ruff format definable/
               mypy definable/definable/ definable/tests_e2e/ --strict-equality --pretty --show-error-codes --config-file=mypy.ini
               pytest definable/tests_e2e/ -m "not openai and not deepseek and not moonshot and not xai and not telegram and not discord and not signal and not postgres and not redis and not qdrant and not chroma and not mongodb and not pinecone and not mistral and not mem0" -v --tb=short
               If any of these fail, fix the issues BEFORE committing. Repeat until clean.

            8. Commit: git add -A && git commit -m "fix(<module>): <description>\n\nFixes #${{ needs.should-fix.outputs.issue_number }}."
            9. Push: git push origin fix/issue-${{ needs.should-fix.outputs.issue_number }}
            10. Create PR â€” you MUST run this command yourself:
                gh pr create --base main --head fix/issue-${{ needs.should-fix.outputs.issue_number }} --title "fix(<module>): <description>" --body "Fixes #${{ needs.should-fix.outputs.issue_number }}

                ## Summary
                <2 sentences: what was broken and how this fixes it>

                ## Changes
                <list files changed>

                ## Testing
                - New test added
                - Linting passes (ruff check + ruff format)
                - Type checking passes (mypy)
                - Test suite passes"

            11. If you CANNOT fix it: gh issue comment ${{ needs.should-fix.outputs.issue_number }} --body "<your analysis>" && gh issue edit ${{ needs.should-fix.outputs.issue_number }} --add-label "needs-human"

          # --dangerously-skip-permissions: required for CI, no human to approve
          # --model: use opus for best reasoning
          # --max-turns: cap to control token usage
          claude_args: "--dangerously-skip-permissions --model claude-opus-4-6 --max-turns 30"

      - name: Update issue on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.should-fix.outputs.issue_number }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "âŒ **Auto-fixer failed** during execution.

          The automated fix attempt encountered an error. A human developer should look at this.

          _Run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})_"

          gh issue edit "$ISSUE_NUMBER" --add-label "needs-human"

      - name: Remove claude-fix label
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.should-fix.outputs.issue_number }}
        run: |
          gh issue edit "$ISSUE_NUMBER" --remove-label "claude-fix" 2>/dev/null || true

      - name: Cleanup workspace
        if: always()
        run: |
          rm -rf .workspace/*
          git checkout main 2>/dev/null || true
