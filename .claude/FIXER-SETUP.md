# Issue Fixer Agent — Setup Guide

## Overview

The Issue Fixer is a Claude Code agent that **automatically fixes GitHub issues**.
When a new issue is created (or labeled `claude-fix`), it:

1. Reads the issue and understands the problem
2. Traces the root cause in the Definable source code
3. Creates a `fix/issue-<N>` branch
4. Implements the fix following library conventions
5. Writes tests that verify the fix
6. Runs the full test suite + linter + type checker
7. Raises a PR with detailed explanation
8. If unable to fix → comments analysis + labels `needs-human`

**Two deployment options:**
- **Option A: GitHub Actions** (recommended — zero infrastructure)
- **Option B: Self-hosted webhook server** (for faster response, more control)

---

## Option A: GitHub Actions (Recommended)

### 1. Authentication — Uses Your Claude Subscription

The workflow uses the official `anthropics/claude-code-action` which supports
authenticating with your **Claude Pro/Max subscription** — no separate API key purchase needed.

**Generate your token:**

```bash
cd /Users/hash/work/definable.ai
claude
```

Inside Claude Code, run:
```
/install-github-app
```

Follow the prompts:
1. Select your repository
2. Install the GitHub App (grants repo permissions)
3. Choose **"Create a long-lived token with your Claude subscription"**
4. Authorize in the browser when prompted
5. It automatically saves `CLAUDE_CODE_OAUTH_TOKEN` as a GitHub secret

That's it. Your subscription now works in GitHub Actions.

**Alternative — if you have API credits:**
If you later want to use API credits instead, go to repo Settings → Secrets → add `ANTHROPIC_API_KEY`, then change the workflow to use `anthropic_api_key` instead of `claude_code_oauth_token`.

### 2. Optional: Add OpenAI Key for Tests

If you want the fixer to run tests that call OpenAI models:
- Go to repo → Settings → Secrets → New repository secret
- Name: `OPENAI_API_KEY`, Value: your OpenAI key

This is optional — the fixer works without it (uses MockModel for tests).

### 3. The Workflow Is Already Created

The file `.github/workflows/fix-issue.yml` is already in your repo. It triggers on:
- **Issue labeled `claude-fix`** — most controlled option
- **Issue opened** (only if you set `AUTOFIX_ON_OPEN=true` in repo variables)
- **Manual dispatch** — go to Actions → "Auto Fix Issue" → Run workflow → enter issue number

### 4. Configure Trigger Behavior

Go to repo → Settings → Variables → Actions → New repository variable:

| Variable | Value | Effect |
|----------|-------|--------|
| `AUTOFIX_ON_OPEN` | `true` or `false` | Auto-fix every new issue (default: `false`) |

**Recommended setup:** Leave `AUTOFIX_ON_OPEN=false` and manually add the `claude-fix` label
to issues you want auto-fixed. This gives you control over which issues trigger the agent.

### 5. Create the Labels

```bash
gh label create "claude-fix" --description "Trigger auto-fix agent" --color "7057ff"
gh label create "needs-human" --description "Auto-fixer couldn't resolve" --color "d73a4a"
```

### 6. Test It

```bash
# Create a test issue
gh issue create --title "Test: Agent should handle None instructions gracefully" \
  --body "When creating Agent(model=model, instructions=None), it should work or raise a clear error." \
  --label "claude-fix"
```

Watch the Actions tab — you should see "Auto Fix Issue" running.

### 7. Cost

Since the workflow uses your Claude subscription:
- **Claude usage**: Counts against your Pro/Max plan allocation (shared with web usage)
- **GitHub Actions minutes**: 5-25 minutes per fix (free tier: 2000 min/month)
- **No separate API costs** unless you switch to `ANTHROPIC_API_KEY`

### 8. Token Refresh

The OAuth token generated by `/install-github-app` is long-lived but may eventually expire.
If the workflow starts failing with auth errors, re-run `/install-github-app` in Claude Code
to generate a fresh token.

---

## Option B: Self-hosted Webhook Server

### 1. Server Setup

```bash
# Create system user
sudo useradd -r -m -d /opt/definable -s /bin/bash definable

# Switch to that user
sudo su - definable

# Clone repo
git clone https://github.com/<your-org>/definable.ai.git /opt/definable/repo
cd /opt/definable/repo

# Create Python venv for the webhook server
python3.12 -m venv /opt/definable/venv
source /opt/definable/venv/bin/activate

# Install webhook server deps
pip install -r .claude/server/requirements.txt

# Install Claude Code CLI
npm install -g @anthropic-ai/claude-code

# Authenticate Claude Code with your subscription
claude /login

# Install GitHub CLI and authenticate
# See: https://cli.github.com/manual/installation
gh auth login

# Create library venv (separate from webhook)
cd /opt/definable/repo
python3.12 -m venv .venv
source .venv/bin/activate
pip install -e ".[readers,serve,jwt,cron,runtime]"
pip install pytest pytest-asyncio

# Create directories
mkdir -p /opt/definable/logs
```

### 2. Configure Environment

```bash
cp /opt/definable/repo/.claude/server/.env.example /opt/definable/.env
nano /opt/definable/.env
```

Fill in:
- `GITHUB_WEBHOOK_SECRET` — generate with `openssl rand -hex 32`
- For the self-hosted server, Claude Code uses your subscription via `claude /login`
  (no `ANTHROPIC_API_KEY` needed if you've logged in)
- `OPENAI_API_KEY` — optional, for tests

### 3. Make Script Executable

```bash
chmod +x /opt/definable/repo/.claude/server/fix-issue.sh
```

### 4. Install Systemd Service

```bash
sudo cp /opt/definable/repo/.claude/server/definable-fixer.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable definable-fixer
sudo systemctl start definable-fixer

# Check status
sudo systemctl status definable-fixer
sudo journalctl -u definable-fixer -f
```

### 5. Configure Nginx (if behind reverse proxy)

```nginx
server {
    listen 443 ssl;
    server_name fixer.definable.ai;

    ssl_certificate /etc/letsencrypt/live/fixer.definable.ai/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/fixer.definable.ai/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:9876;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 10m;
        proxy_read_timeout 1800;
    }
}
```

### 6. Configure GitHub Webhook

Go to your repo → Settings → Webhooks → Add webhook:

| Field | Value |
|-------|-------|
| Payload URL | `https://fixer.definable.ai/webhook` |
| Content type | `application/json` |
| Secret | Same value as `GITHUB_WEBHOOK_SECRET` in `.env` |
| Events | Select "Issues" only |
| Active | ✅ |

### 7. Test

```bash
curl https://fixer.definable.ai/health
curl -X POST https://fixer.definable.ai/fix/42
curl https://fixer.definable.ai/status
```

---

## How the Agent Decides What to Do

```
Issue Opened/Labeled
        │
        ▼
┌──────────────────┐     ┌─────────────┐
│ Skip labels?     │──→  │ Ignore      │
│ (wontfix, dup..) │ yes │             │
└────────┬─────────┘     └─────────────┘
         │ no
         ▼
┌──────────────────┐     ┌─────────────┐
│ claude-fix label │──→  │ Start fix   │
│ or AUTOFIX=true? │ yes │             │
└────────┬─────────┘     └─────────────┘
         │ no
         ▼
    Ignore

Start fix
    │
    ▼
┌──────────────────┐     ┌─────────────────┐
│ Read issue       │──→  │ No repro steps? │──→ Comment "needs-info", stop
│ Parse content    │     │ Unclear?        │
└────────┬─────────┘     └─────────────────┘
         │
         ▼
┌──────────────────┐     ┌─────────────────┐
│ Reproduce bug    │──→  │ Can't repro?    │──→ Comment "can't reproduce", stop
└────────┬─────────┘     └─────────────────┘
         │
         ▼
┌──────────────────┐
│ Root cause       │
│ analysis         │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Create branch    │
│ fix/issue-<N>    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Implement fix    │
│ + write tests    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐     ┌─────────────────┐
│ All tests pass?  │──→  │ No?            │──→ Fix or revert
└────────┬─────────┘     └─────────────────┘
         │ yes
         ▼
┌──────────────────┐     ┌─────────────────────────┐
│ Confident in fix?│──→  │ No?                     │──→ Comment analysis,
└────────┬─────────┘     │ (too complex, design    │    label needs-human,
         │ yes           │  decision needed, etc.)  │    delete branch
         ▼               └─────────────────────────┘
┌──────────────────┐
│ Push + create PR │
│ referencing #N   │
└──────────────────┘
```

---

## Troubleshooting

| Issue | Solution |
|-------|----------|
| Workflow doesn't trigger | Check: issue must be `open`, no skip labels, `claude-fix` label present |
| Auth error: token expired | Re-run `/install-github-app` in Claude Code to refresh the token |
| Agent can't push branch | Check `GITHUB_TOKEN` permissions: needs `contents: write` |
| Agent can't create PR | Check `GITHUB_TOKEN` permissions: needs `pull-requests: write` |
| Tests fail on CI but pass locally | Check Python version and installed extras match CI |
| Agent keeps timing out | Increase `timeout-minutes` in workflow (default: 30) |
| Agent creates bad fix | Review and close the PR, tweak `.claude/agents/issue-fixer.md` |
| Too many API costs | Set `AUTOFIX_ON_OPEN=false`, use `claude-fix` label for selective triggering |
| Self-hosted: webhook not receiving | Check nginx config, firewall, GitHub webhook delivery log |
